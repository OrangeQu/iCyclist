# iCyclist 本地测试部署指南

本指南将帮助你在本地环境下配置和运行 iCyclist 的前后端系统。

---

## 📋 目录

1. [环境要求](#环境要求)
2. [后端部署](#后端部署)
3. [前端配置](#前端配置)
4. [测试连接](#测试连接)
5. [常见问题](#常见问题)

---

## 🛠️ 环境要求

### 后端要求
- **JDK**: 17 或更高版本
- **MySQL**: 8.0 或更高版本
- **IDE**: IntelliJ IDEA（推荐）或其他支持 Kotlin 的 IDE

### 前端要求
- **Android Studio**: Flamingo 或更高版本
- **Android 设备或模拟器**: API 26 (Android 8.0) 或更高
- **网络**: 手机/模拟器与电脑在同一 WiFi 网络

---

## 🖥️ 后端部署

### 步骤 1：安装 MySQL 数据库

1. 下载并安装 MySQL 8.0
   - Windows: https://dev.mysql.com/downloads/installer/
   - macOS: `brew install mysql`

2. 启动 MySQL 服务
   ```bash
   # Windows: 在服务中启动 MySQL
   # macOS/Linux
   mysql.server start
   ```

3. 创建数据库
   ```sql
   # 登录 MySQL
   mysql -u root -p
   
   # 创建数据库
   CREATE DATABASE icyclist CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   
   # 创建用户（可选，推荐）
   CREATE USER 'icyclist'@'localhost' IDENTIFIED BY 'your_password';
   GRANT ALL PRIVILEGES ON icyclist.* TO 'icyclist'@'localhost';
   FLUSH PRIVILEGES;
   ```

### 步骤 2：配置数据库连接

1. 打开 `server/src/main/resources/application.properties`

2. 修改数据库配置：
   ```properties
   spring.datasource.url=jdbc:mysql://localhost:3306/icyclist?useUnicode=true&characterEncoding=utf-8&serverTimezone=UTC
   spring.datasource.username=root
   spring.datasource.password=你的MySQL密码
   ```

### 步骤 3：创建数据库表

在 MySQL 中执行以下 SQL 脚本创建必要的表：

```sql
USE icyclist;

-- 用户表
CREATE TABLE user (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    nickname VARCHAR(100),
    avatar VARCHAR(255),
    gender INT DEFAULT 0,
    bio TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 骑行记录表
CREATE TABLE ride_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    distance DOUBLE,
    duration BIGINT,
    avg_speed DOUBLE,
    track_points TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
);

-- 论坛分类表
CREATE TABLE forum_category (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 论坛主题表
CREATE TABLE forum_topic (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    category_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES forum_category(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
);

-- 论坛回复表
CREATE TABLE forum_reply (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    topic_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (topic_id) REFERENCES forum_topic(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
);

-- 骑行圈帖子表
CREATE TABLE post (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    ride_record_id BIGINT,
    content TEXT,
    media_urls TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE,
    FOREIGN KEY (ride_record_id) REFERENCES ride_record(id) ON DELETE SET NULL
);

-- 帖子点赞表
CREATE TABLE post_like (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    post_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY unique_post_user (post_id, user_id),
    FOREIGN KEY (post_id) REFERENCES post(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
);

-- 帖子评论表
CREATE TABLE comment (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    post_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (post_id) REFERENCES post(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
);

-- 插入测试数据
-- 论坛分类
INSERT INTO forum_category (name, description) VALUES
('装备讨论', '分享和讨论骑行装备'),
('路线分享', '推荐你最喜欢的骑行路线'),
('新手问答', '新手上路？在这里提问吧'),
('骑闻轶事', '分享骑行中的趣闻和故事'),
('二手交易', '买卖你的闲置骑行装备');

-- 测试用户
INSERT INTO user (username, password_hash, nickname, bio) VALUES
('test@example.com', 'test123', '测试用户', '这是一个测试账号');
```

### 步骤 4：运行后端服务

1. 在 IntelliJ IDEA 中打开 `iCyclist/server` 项目

2. 等待 Gradle 同步完成

3. 找到 `ServerApplication.kt` 文件

4. 右键点击，选择 `Run 'ServerApplication'`

5. 看到以下输出表示启动成功：
   ```
   Started ServerApplication in X.XXX seconds
   ```

6. 后端服务默认运行在 `http://localhost:8080`

### 步骤 5：查看你的电脑 IP 地址

**这一步非常重要！** Android 设备需要通过 IP 地址访问电脑上的后端服务。

#### Windows
1. 打开命令提示符（cmd）
2. 输入命令：
   ```bash
   ipconfig
   ```
3. 找到 `无线局域网适配器 WLAN` 或 `以太网适配器` 下的 `IPv4 地址`
4. 例如：`192.168.1.100`

#### macOS
1. 打开终端
2. 输入命令：
   ```bash
   ifconfig | grep "inet " | grep -v 127.0.0.1
   ```
3. 或者：系统偏好设置 → 网络 → 查看 IP 地址

#### Linux
```bash
ip addr show | grep "inet " | grep -v 127.0.0.1
```

**记住这个 IP 地址，下一步会用到！**

---

## 📱 前端配置

### 步骤 1：修改服务器地址

1. 打开 `app/src/main/java/com/example/icyclist/network/RetrofitClient.kt`

2. 找到第 25 行左右的 `BASE_URL` 配置：
   ```kotlin
   private const val BASE_URL = "http://192.168.1.100:8080/"
   ```

3. **将 `192.168.1.100` 替换为你的电脑实际 IP 地址**（上一步查到的）
   
   例如：
   ```kotlin
   private const val BASE_URL = "http://192.168.1.123:8080/"
   ```

### 步骤 2：确保网络连接

1. **手机和电脑必须在同一 WiFi 网络**
2. 关闭电脑防火墙（或允许 8080 端口）
   - Windows: 控制面板 → Windows Defender 防火墙 → 允许应用通过防火墙
   - macOS: 系统偏好设置 → 安全性与隐私 → 防火墙选项

### 步骤 3：运行 Android 应用

1. 在 Android Studio 中打开项目
2. 点击 `Sync Project with Gradle Files`
3. 连接 Android 设备或启动模拟器
4. 点击 `Run 'app'`

---

## 🧪 测试连接

### 测试 1：浏览器测试

在电脑浏览器中访问：
```
http://localhost:8080/api/forum/categories
```

应该返回论坛分类的 JSON 数据。

### 测试 2：手机浏览器测试

在手机浏览器中访问（替换为你的电脑 IP）：
```
http://192.168.1.100:8080/api/forum/categories
```

如果能看到 JSON 数据，说明网络连接正常。

### 测试 3：App 功能测试

1. 打开 App
2. 进入"论坛"Tab
3. 查看是否加载到论坛分类
   - ✅ 成功：显示分类列表
   - ❌ 失败：显示假数据 + Toast 提示错误信息

---

## ❓ 常见问题

### 问题 1：App 提示"网络错误"

**解决方法：**
1. 检查手机和电脑是否在同一 WiFi
2. 检查 `RetrofitClient.kt` 中的 IP 地址是否正确
3. 检查后端服务是否正在运行（浏览器访问 `http://localhost:8080/api/forum/categories`）
4. 检查电脑防火墙是否阻止了 8080 端口

### 问题 2：后端启动失败

**可能原因：**
- MySQL 未启动
- 数据库连接配置错误
- 端口 8080 被占用

**解决方法：**
1. 检查 MySQL 服务是否运行
2. 检查 `application.properties` 中的数据库配置
3. 修改端口（在 `application.properties` 中添加 `server.port=8081`）

### 问题 3：数据库连接失败

**错误信息：** `Access denied for user 'root'@'localhost'`

**解决方法：**
检查 `application.properties` 中的用户名和密码是否正确。

### 问题 4：手机无法访问电脑 IP

**解决方法：**
1. 确认手机和电脑在同一网络
2. 关闭电脑防火墙测试
3. 尝试 ping 电脑 IP（Android Terminal 或 ADB）：
   ```bash
   adb shell ping 192.168.1.100
   ```

### 问题 5：论坛分类显示空列表

**解决方法：**
确保已执行步骤 3 中的 SQL 脚本，插入了测试数据。

---

## 🎯 下一步

配置完成后，你可以：

1. **测试论坛功能**
   - 查看论坛分类
   - 创建主题和回复（需要先实现创建功能的 UI 交互）

2. **测试骑行圈功能**
   - 查看所有用户的骑行分享

3. **扩展功能**
   - 添加用户注册/登录的网络请求
   - 实现图片上传功能
   - 添加点赞、评论功能

---

## 📞 技术支持

如果遇到问题：

1. 查看 Android Logcat 日志（搜索 `OkHttp` 或 `Retrofit`）
2. 查看后端控制台输出
3. 检查数据库中是否有数据

---

**祝你部署成功！🎉**

