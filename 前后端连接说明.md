# iCyclist 前后端连接说明

## ✅ 已完成的修改

### 📦 1. 添加了网络请求依赖
- Retrofit 2.9.0
- OkHttp 4.12.0
- Gson 转换器

### 🔌 2. 创建了网络层架构
```
app/src/main/java/com/example/icyclist/network/
├── ApiService.kt              # API 接口定义
├── RetrofitClient.kt          # Retrofit 配置
└── model/                     # 网络数据模型
    ├── User.kt
    ├── Post.kt
    ├── Comment.kt
    ├── PostLike.kt
    └── forum/
        ├── ForumCategory.kt
        ├── ForumTopic.kt
        └── ForumReply.kt
```

### 🌐 3. 实现了前后端接口对接

#### 论坛模块
- ✅ `CommunityFragment` - 加载论坛分类
- ✅ `TopicListActivity` - 加载主题列表
- ✅ `TopicDetailActivity` - 加载主题详情和回复

#### 骑行圈模块
- ✅ `MomentFragment` - 加载骑行圈帖子

### 🔐 4. 配置了网络权限
- 添加了 HTTP 明文传输支持（本地测试用）
- 创建了网络安全配置文件

---

## 🚀 快速开始（3 步搞定）

### 步骤 1：启动后端
```bash
# 1. 启动 MySQL 数据库
# 2. 创建 icyclist 数据库
# 3. 执行 SQL 脚本创建表（见"本地部署指南.md"）
# 4. 运行 ServerApplication.kt
```

### 步骤 2：配置前端 IP 地址
```kotlin
// 打开: app/src/main/java/com/example/icyclist/network/RetrofitClient.kt
// 第 25 行，修改为你的电脑 IP:

private const val BASE_URL = "http://你的电脑IP:8080/"
// 例如: "http://192.168.1.100:8080/"
```

### 步骤 3：运行 App
- 确保手机和电脑在同一 WiFi
- 运行 Android 应用
- 进入"论坛"或"骑友圈"Tab 测试

---

## 📋 API 接口清单

### 论坛接口
| 接口 | 方法 | 说明 | 状态 |
|------|------|------|------|
| `/api/forum/categories` | GET | 获取论坛分类 | ✅ 已对接 |
| `/api/forum/categories/{id}/topics` | GET | 获取主题列表 | ✅ 已对接 |
| `/api/forum/topics/{id}` | GET | 获取主题详情 | ✅ 已对接 |
| `/api/forum/topics` | POST | 创建主题 | ⚠️ 接口已定义，待 UI 实现 |
| `/api/forum/topics/{id}/replies` | POST | 创建回复 | ⚠️ 接口已定义，待 UI 实现 |

### 骑行圈接口
| 接口 | 方法 | 说明 | 状态 |
|------|------|------|------|
| `/api/posts` | GET | 获取帖子列表 | ✅ 已对接 |
| `/api/posts/{id}` | GET | 获取帖子详情 | ⚠️ 接口已定义，待使用 |
| `/api/posts` | POST | 创建帖子 | ⚠️ 接口已定义，待使用 |
| `/api/posts/{id}/comments` | POST | 添加评论 | ⚠️ 接口已定义，待使用 |
| `/api/posts/{id}/like` | POST | 点赞/取消点赞 | ⚠️ 接口已定义，待使用 |

---

## 🎨 特性说明

### 1. 智能降级机制
所有网络请求都有后备方案：
- **网络成功** → 显示服务器数据
- **网络失败** → 显示本地假数据 + Toast 提示错误

### 2. JWT 认证支持
- `RetrofitClient` 自动在请求头添加 Token
- `UserManager` 提供 Token 存储和获取方法

### 3. 日志调试
- 使用 `HttpLoggingInterceptor` 打印所有网络请求
- 在 Logcat 中搜索 `OkHttp` 查看详细日志

---

## 🔍 调试技巧

### 查看网络请求日志
```
Android Studio Logcat 搜索:
- "OkHttp" - 查看所有网络请求和响应
- "RetrofitClient" - 查看 Retrofit 初始化信息
```

### 测试后端接口
```bash
# 使用浏览器或 curl 测试

# 获取论坛分类
curl http://localhost:8080/api/forum/categories

# 获取主题列表（分类 ID = 1）
curl http://localhost:8080/api/forum/categories/1/topics

# 获取帖子列表
curl http://localhost:8080/api/posts
```

---

## ⚠️ 重要提示

### 本地测试注意事项
1. **IP 地址**: 每次 WiFi 变化后，可能需要重新配置 IP
2. **防火墙**: Windows/Mac 防火墙可能阻止 8080 端口
3. **HTTP vs HTTPS**: 本地测试使用 HTTP，生产环境必须改为 HTTPS
4. **网络权限**: 已配置 `usesCleartextTraffic="true"`，仅用于开发

### 生产环境部署
部署到真实服务器时，需要修改：
1. `RetrofitClient.kt` 中的 `BASE_URL` 改为 HTTPS 地址
2. 移除 `network_security_config.xml` 中的 `cleartextTrafficPermitted="true"`
3. 移除 `AndroidManifest.xml` 中的 `usesCleartextTraffic="true"`

---

## 📚 相关文档

- 详细部署步骤：[本地部署指南.md](./本地部署指南.md)
- 项目说明：[README.md](./README.md)
- 后端 API 文档：查看 `server/src/main/kotlin/com/icyclist/server/controller/`

---

**开发愉快！有问题随时查看日志 📝**

