# iCyclist 项目部署与使用说明

## 🎯 项目概述

iCyclist 是一个完整的骑行社交应用，包含：
- 📱 **Android客户端**: Kotlin + Room + Retrofit + 高德地图
- 🖥️ **Spring Boot后端**: Spring Boot + MyBatis + MySQL + JWT认证
- 🔄 **双层架构**: 服务器数据 + 本地缓存

## 📋 前置要求

### 后端要求
- ✅ Java 17+
- ✅ MySQL 8.0+
- ✅ Maven 3.6+

### 客户端要求
- ✅ Android Studio Hedgehog+ (2023.1.1+)
- ✅ Android SDK 24+ (最低版本)
- ✅ Android SDK 34 (目标版本)
- ✅ Kotlin 1.9+

## 🚀 部署步骤

### 第一步：部署后端服务器

#### 1. 配置数据库

```sql
-- 创建数据库
CREATE DATABASE icyclist CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选）
CREATE USER 'icyclist'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON icyclist.* TO 'icyclist'@'localhost';
FLUSH PRIVILEGES;
```

#### 2. 修改配置文件

编辑 `server/src/main/resources/application.properties`:

```properties
# 数据库配置（修改为你的配置）
spring.datasource.url=jdbc:mysql://localhost:3306/icyclist?useUnicode=true&characterEncoding=utf-8&serverTimezone=UTC
spring.datasource.username=root
spring.datasource.password=你的数据库密码

# 服务器端口
server.port=8080

# JWT配置（可以修改密钥）
jwt.secret=your-super-secret-key-that-is-long-enough-to-be-secure-32-bytes
jwt.expiration=86400000
```

#### 3. 启动服务器

```bash
cd server
./gradlew bootRun

# 或者打包后运行
./gradlew build
java -jar build/libs/server-1.0.0.jar
```

服务器启动成功后会在 `http://localhost:8080` 监听。

#### 4. 验证服务器

访问以下URL测试：
- `http://localhost:8080/api/forum/categories` - 应返回论坛分类JSON

### 第二步：配置Android客户端

#### 1. 配置服务器地址

编辑 `app/src/main/java/com/example/icyclist/network/RetrofitClient.kt`:

```kotlin
// 修改为你的服务器IP
private const val BASE_URL = "http://你的IP地址:8080/"

// 示例：
// - 本地测试: "http://192.168.1.100:8080/"
// - 局域网: "http://192.168.x.x:8080/"
// - 云服务器: "http://your-domain.com:8080/"
```

**⚠️ 注意事项**:
- 不要使用 `localhost` 或 `127.0.0.1`（除非使用模拟器+端口转发）
- Android 9+ 需要支持明文HTTP，已在 `network_security_config.xml` 中配置
- 确保手机和服务器在同一局域网（或服务器有公网IP）

#### 2. 配置高德地图API Key

复制 `app/apikeys.properties.example` 为 `app/apikeys.properties`:

```properties
AMAP_API_KEY=你的高德地图API Key
```

获取高德地图Key: https://console.amap.com/

#### 3. 构建并安装

```bash
# 在Android Studio中
1. 打开项目
2. 等待Gradle同步完成
3. 连接Android设备或启动模拟器
4. 点击 Run 按钮
```

## 📱 使用指南

### 首次使用

1. **注册账号**
   - 打开APP，点击"注册"
   - 输入邮箱、昵称、密码
   - 点击注册（数据会发送到服务器）

2. **登录**
   - 使用注册的邮箱和密码登录
   - 登录成功后会保存JWT Token

3. **开始使用**
   - 🏃 **骑行**: 点击"开始骑行"按钮，记录轨迹
   - 🌐 **论坛**: 浏览论坛分类，发布主题
   - 📷 **骑行圈**: 发布骑行动态，分享照片
   - 👤 **个人**: 查看个人信息和骑行历史

### 功能说明

#### 1. 骑行记录
- 点击"开始骑行"开始GPS轨迹记录
- 实时显示距离、速度、时间
- 结束后自动保存到本地和服务器
- 支持暂停/继续功能

#### 2. 论坛社区
- 浏览5个论坛分类：装备讨论、路线分享、新手问答、骑闻轶事、二手交易
- 发布新主题（支持标题和内容）
- 查看主题和回复
- 数据实时同步到服务器

#### 3. 骑行圈
- 发布骑行动态（支持文字和图片）
- 点赞和评论功能
- 查看其他骑友的动态
- 所有互动数据实时同步

#### 4. 个人中心
- 查看骑行统计
- 编辑个人资料
- 查看历史记录

## 🔧 故障排查

### 常见问题

#### 1. 无法连接服务器

**现象**: 登录/注册/加载数据失败，提示网络错误

**解决方案**:
```bash
# 检查服务器是否运行
curl http://192.168.x.x:8080/api/forum/categories

# 检查手机和电脑是否在同一网络
# 检查防火墙设置（允许8080端口）

# Windows防火墙规则
netsh advfirewall firewall add rule name="Spring Boot" dir=in action=allow protocol=TCP localport=8080

# 检查RetrofitClient中的BASE_URL是否正确
```

#### 2. 登录失败 401

**原因**: JWT Token过期或无效

**解决方案**:
- 重新登录
- 清除APP数据后重新登录

#### 3. 论坛/帖子加载为空

**原因**: 服务器数据库为空

**解决方案**:
- 使用APP注册几个测试账号
- 发布一些测试数据
- 或运行后端的数据初始化脚本（如果有）

#### 4. 高德地图不显示

**原因**: API Key未配置或无效

**解决方案**:
- 检查 `apikeys.properties` 是否存在
- 在高德开放平台添加APP的SHA1指纹
- 重新构建项目

#### 5. 数据不同步

**现象**: 在一个设备上发布的内容，另一个设备看不到

**原因**: 两个设备使用不同的账号，或缓存未刷新

**解决方案**:
- 下拉刷新页面
- 退出重新进入
- 检查是否使用同一账号

## 🛠️ 开发者说明

### 网络请求架构

所有网络请求遵循以下模式：

```kotlin
lifecycleScope.launch {
    try {
        // 1. 调用服务器API
        val response = apiService.getData()
        
        if (response.isSuccessful && response.body() != null) {
            // 2. 使用服务器数据
            val data = response.body()!!
            updateUI(data)
            
            // 3. 更新本地缓存
            saveToCache(data)
        } else {
            // 4. 服务器失败，降级到缓存
            loadFromCache()
        }
    } catch (e: Exception) {
        // 5. 网络错误，降级到缓存
        loadFromCache()
    }
}
```

### API列表

#### 用户认证
- `POST /api/users/register` - 注册
- `POST /api/users/login` - 登录

#### 论坛
- `GET /api/forum/categories` - 获取分类列表
- `GET /api/forum/categories/{id}/topics` - 获取主题列表
- `GET /api/forum/topics/{id}` - 获取主题详情
- `POST /api/forum/topics` - 创建主题
- `POST /api/forum/topics/{id}/replies` - 创建回复

#### 骑行圈
- `GET /api/posts` - 获取帖子列表
- `GET /api/posts/{id}` - 获取帖子详情
- `POST /api/posts` - 创建帖子
- `POST /api/posts/{id}/comments` - 添加评论
- `POST /api/posts/{id}/like` - 切换点赞

#### 骑行记录
- `POST /api/rides` - 上传骑行记录
- `GET /api/rides` - 获取骑行记录列表
- `GET /api/rides/{id}` - 获取骑行记录详情

### 数据库表结构

详见后端 `mapper/*.xml` 文件。

## 📞 技术支持

如遇到其他问题，请检查：
1. Android Studio 的 Logcat 日志
2. 服务器控制台输出
3. MySQL数据库连接状态

---

**祝你骑行愉快！🚴‍♂️**

