# iCyclist æŠ€æœ¯æ–‡æ¡£

## ğŸ“‘ ç›®å½•

1. [æ ¸å¿ƒæŠ€æœ¯æ¶æ„](#æ ¸å¿ƒæŠ€æœ¯æ¶æ„)
2. [æ•°æ®åº“è®¾è®¡è¯¦è§£](#æ•°æ®åº“è®¾è®¡è¯¦è§£)
3. [å…³é”®åŠŸèƒ½å®ç°](#å…³é”®åŠŸèƒ½å®ç°)
4. [UI/UXè®¾è®¡è§„èŒƒ](#uiuxè®¾è®¡è§„èŒƒ)
5. [æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ](#æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ)
6. [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
7. [APIæ¥å£æ–‡æ¡£](#apiæ¥å£æ–‡æ¡£)
8. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)

---

## æ ¸å¿ƒæŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Presentation Layer                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Activity â”‚  â”‚ Fragment â”‚  â”‚ Adapter  â”‚  â”‚  Dialog  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Business Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ViewModelâ”‚  â”‚ Manager  â”‚  â”‚  Utils   â”‚  â”‚  Helper  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“ â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Data Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Room DB â”‚  â”‚SharedPrefâ”‚  â”‚  Network â”‚  â”‚  Storage â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### MVVMæ¨¡å¼åº”ç”¨

è™½ç„¶é¡¹ç›®ä¸»è¦ä½¿ç”¨ä¼ ç»Ÿçš„MVCæ¨¡å¼ï¼Œä½†åœ¨éƒ¨åˆ†æ¨¡å—ä¸­èå…¥äº†MVVMæ€æƒ³ï¼š

```kotlin
// Fragment (View) è´Ÿè´£UIå±•ç¤º
class MomentFragment : Fragment() {
    private lateinit var adapter: CommunityPostAdapter
    
    private fun loadPosts() {
        lifecycleScope.launch {
            val posts = withContext(Dispatchers.IO) {
                database.communityPostDao().getAllPosts()
            }
            adapter.updateData(posts)
        }
    }
}

// UserManager (ç±»ä¼¼ViewModel) è´Ÿè´£ä¸šåŠ¡é€»è¾‘
object UserManager {
    fun getCurrentUserEmail(context: Context): String? {
        return getEncryptedPreferences(context)
            .getString(KEY_CURRENT_USER_EMAIL, null)
    }
}

// Room Database (Model) è´Ÿè´£æ•°æ®æŒä¹…åŒ–
@Database(entities = [...], version = 5)
abstract class SportDatabase : RoomDatabase() {
    abstract fun communityPostDao(): CommunityPostDao
}
```

---

## æ•°æ®åº“è®¾è®¡è¯¦è§£

### ERå…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚ (SharedPreferenceså­˜å‚¨)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚
       â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      N        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚SportRecord  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚CommunityPostâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ 1
                               â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                               â”‚ N           â”‚ N
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚Comment  â”‚    â”‚  Like   â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      1        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ForumCategory â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  ForumTopic  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       N        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚ 1
                                       â”‚ N
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ ForumReply   â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡¨ç»“æ„è¯¦è§£

#### 1. sport_records è¡¨

**å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|--------|------|------|------|
| id | INTEGER | ä¸»é”®ï¼Œè‡ªå¢ | PRIMARY KEY |
| startTime | LONG | å¼€å§‹æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ | NOT NULL |
| endTime | LONG | ç»“æŸæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ | NOT NULL |
| duration | LONG | è¿åŠ¨æ—¶é•¿ï¼ˆç§’ï¼‰ | NOT NULL |
| distance | FLOAT | è¿åŠ¨è·ç¦»ï¼ˆç±³ï¼‰ | NOT NULL |
| averageSpeed | FLOAT | å¹³å‡é€Ÿåº¦ï¼ˆkm/hï¼‰ | NOT NULL |
| maxSpeed | FLOAT | æœ€å¤§é€Ÿåº¦ï¼ˆkm/hï¼‰ | NOT NULL |
| calories | INTEGER | æ¶ˆè€—å¡è·¯é‡Œ | NOT NULL |
| trackPoints | TEXT | è½¨è¿¹åæ ‡ç‚¹JSON | NOT NULL |
| thumbnailPath | TEXT | ç¼©ç•¥å›¾è·¯å¾„ | NULLABLE |

**ç´¢å¼•è®¾è®¡ï¼š**
```sql
-- æŒ‰æ—¶é—´æŸ¥è¯¢ç´¢å¼•
CREATE INDEX idx_sport_start_time ON sport_records(startTime DESC);
```

**trackPoints JSONæ ¼å¼ï¼š**
```json
[
  {
    "latitude": 39.9042,
    "longitude": 116.4074,
    "timestamp": 1634567890000,
    "speed": 15.5
  },
  ...
]
```

#### 2. community_posts è¡¨

**å…³è”å…³ç³»ï¼š**
- `sportRecordId` å¤–é”®å…³è” `sport_records.id`ï¼ˆå¯é€‰ï¼‰

**ä¸šåŠ¡é€»è¾‘ï¼š**
- æ™®é€šå¸–å­ï¼š`sportRecordId` ä¸º NULL
- è¿åŠ¨åˆ†äº«å¸–ï¼šåŒ…å« `sportRecordId`ã€`sportDistance`ã€`sportDuration`ã€`sportThumbPath`

#### 3. likes è¡¨ï¼ˆè”åˆä¸»é”®ï¼‰

**è”åˆä¸»é”®è®¾è®¡ï¼š**
```kotlin
@Entity(tableName = "likes", primaryKeys = ["postId", "userId"])
```

**ä¼˜åŠ¿ï¼š**
- é˜²æ­¢é‡å¤ç‚¹èµ
- æŸ¥è¯¢æ•ˆç‡é«˜
- æ•°æ®ä¸€è‡´æ€§ä¿è¯

**æŸ¥è¯¢ç¤ºä¾‹ï¼š**
```kotlin
// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç‚¹èµ
@Query("SELECT COUNT(*) FROM likes WHERE postId = :postId AND userId = :userId")
suspend fun isLiked(postId: Int, userId: String): Int

// è·å–å¸–å­ç‚¹èµæ•°
@Query("SELECT COUNT(*) FROM likes WHERE postId = :postId")
suspend fun getLikeCount(postId: Int): Int
```

### æ•°æ®åº“è¿ç§»ç­–ç•¥

#### ç‰ˆæœ¬è¿ç§»æµç¨‹

```kotlin
// MIGRATION_4_5: æ·»åŠ ç¤ºä¾‹æ•°æ®
private val MIGRATION_4_5 = object : Migration(4, 5) {
    override fun migrate(db: SupportSQLiteDatabase) {
        val currentTime = System.currentTimeMillis()
        
        // 1. æ’å…¥è®ºå›ä¸»é¢˜æ•°æ®
        db.execSQL("""
            INSERT INTO forum_topics 
            (categoryId, userId, userNickname, userAvatar, title, content, timestamp, replyCount) 
            VALUES (1, 'user@example.com', 'éª‘è¡Œè¾¾äºº', 'ic_twotone_person_24', 
                    'æ±‚æ¨èå…¥é—¨çº§å…¬è·¯è½¦', 'é¢„ç®—5000å·¦å³...', $currentTime, 0)
        """)
        
        // 2. æ’å…¥å›å¤æ•°æ®
        db.execSQL("""
            INSERT INTO forum_replies 
            (topicId, userId, userNickname, userAvatar, content, timestamp) 
            VALUES (1, 'expert@example.com', 'éª‘è¡Œä¸“å®¶', 'ic_twotone_person_24', 
                    'æ¨èç¾åˆ©è¾¾...', $currentTime)
        """)
        
        // 3. æ›´æ–°ä¸»é¢˜å›å¤è®¡æ•°
        db.execSQL("UPDATE forum_topics SET replyCount = 2 WHERE id = 1")
    }
}
```

#### è¿ç§»æ³¨æ„äº‹é¡¹

1. **ä¿æŒå‘åå…¼å®¹**ï¼šæ—§ç‰ˆæœ¬æ•°æ®ä¸ä¸¢å¤±
2. **äº‹åŠ¡ä¿è¯**ï¼šè¿ç§»å¤±è´¥è‡ªåŠ¨å›æ»š
3. **æµ‹è¯•éªŒè¯**ï¼šæ¯æ¬¡è¿ç§»åéªŒè¯æ•°æ®å®Œæ•´æ€§
4. **ç‰ˆæœ¬æ§åˆ¶**ï¼šä¸¥æ ¼é€’å¢ç‰ˆæœ¬å·

---

## å…³é”®åŠŸèƒ½å®ç°

### 1. GPSè½¨è¿¹è¿½è¸ª

#### å®šä½é…ç½®

```kotlin
// åˆå§‹åŒ–å®šä½å®¢æˆ·ç«¯
private fun initLocationClient() {
    locationClient = AMapLocationClient(requireContext().applicationContext)
    
    val option = AMapLocationClientOption().apply {
        // å®šä½æ¨¡å¼
        locationMode = AMapLocationClientOption.AMapLocationMode.Hight_Accuracy
        
        // å®šä½é—´éš”ï¼ˆæ¯«ç§’ï¼‰
        interval = 2000L  // 2ç§’æ›´æ–°ä¸€æ¬¡
        
        // æ˜¯å¦è¿”å›åœ°å€ä¿¡æ¯
        isNeedAddress = false
        
        // æ˜¯å¦å…è®¸æ¨¡æ‹Ÿä½ç½®
        isMockEnable = false
        
        // è®¾ç½®å®šä½è¶…æ—¶æ—¶é—´
        httpTimeOut = 30000
        
        // å•æ¬¡å®šä½è¿˜æ˜¯è¿ç»­å®šä½
        isOnceLocation = false
    }
    
    locationClient?.setLocationOption(option)
    locationClient?.setLocationListener(this)
}
```

#### è½¨è¿¹ç‚¹é‡‡é›†ç®—æ³•

```kotlin
override fun onLocationChanged(location: AMapLocation?) {
    location?.let { loc ->
        if (loc.errorCode == 0) {
            val currentPoint = TrackPoint(
                latitude = loc.latitude,
                longitude = loc.longitude,
                timestamp = System.currentTimeMillis(),
                speed = loc.speed  // m/s
            )
            
            // è¿‡æ»¤æ— æ•ˆç‚¹
            if (isValidPoint(currentPoint, lastPoint)) {
                trackPoints.add(currentPoint)
                
                // ç»˜åˆ¶è½¨è¿¹çº¿
                updateMapTrack(currentPoint)
                
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                updateSportData(currentPoint)
                
                lastPoint = currentPoint
            }
        }
    }
}

// ç‚¹æœ‰æ•ˆæ€§åˆ¤æ–­
private fun isValidPoint(current: TrackPoint, last: TrackPoint?): Boolean {
    if (last == null) return true
    
    // 1. é€Ÿåº¦åˆç†æ€§æ£€æŸ¥ï¼ˆä¸è¶…è¿‡60km/hï¼‰
    if (current.speed > 16.67f) return false  // 60km/h = 16.67m/s
    
    // 2. è·ç¦»åˆç†æ€§æ£€æŸ¥ï¼ˆä¸¤ç‚¹é—´è·ç¦»ä¸è¶…è¿‡100ç±³ï¼‰
    val distance = calculateDistance(last, current)
    if (distance > 100f) return false
    
    // 3. æ—¶é—´é—´éš”æ£€æŸ¥
    val timeInterval = current.timestamp - last.timestamp
    if (timeInterval < 1000) return false  // è‡³å°‘1ç§’é—´éš”
    
    return true
}
```

#### è·ç¦»è®¡ç®—ï¼ˆHaversineå…¬å¼ï¼‰

```kotlin
fun calculateDistance(point1: TrackPoint, point2: TrackPoint): Float {
    val R = 6371000.0  // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
    
    val lat1 = Math.toRadians(point1.latitude)
    val lat2 = Math.toRadians(point2.latitude)
    val dLat = Math.toRadians(point2.latitude - point1.latitude)
    val dLon = Math.toRadians(point2.longitude - point1.longitude)
    
    val a = sin(dLat / 2) * sin(dLat / 2) +
            cos(lat1) * cos(lat2) *
            sin(dLon / 2) * sin(dLon / 2)
    
    val c = 2 * atan2(sqrt(a), sqrt(1 - a))
    
    return (R * c).toFloat()
}
```

#### å®æ—¶æ•°æ®æ›´æ–°

```kotlin
private fun updateSportData(currentPoint: TrackPoint) {
    // æ›´æ–°æ€»è·ç¦»
    if (lastPoint != null) {
        val segmentDistance = calculateDistance(lastPoint!!, currentPoint)
        totalDistance += segmentDistance
    }
    
    // æ›´æ–°è¿åŠ¨æ—¶é•¿
    val elapsedTime = (System.currentTimeMillis() - startTime) / 1000
    
    // è®¡ç®—å¹³å‡é€Ÿåº¦
    averageSpeed = if (elapsedTime > 0) {
        (totalDistance / elapsedTime) * 3.6f  // è½¬æ¢ä¸ºkm/h
    } else 0f
    
    // æ›´æ–°æœ€å¤§é€Ÿåº¦
    val currentSpeedKmh = currentPoint.speed * 3.6f
    if (currentSpeedKmh > maxSpeed) {
        maxSpeed = currentSpeedKmh
    }
    
    // ä¼°ç®—å¡è·¯é‡Œæ¶ˆè€—ï¼ˆç®€åŒ–å…¬å¼ï¼‰
    val distanceKm = totalDistance / 1000f
    calories = (distanceKm * 50).toInt()  // æ¯å…¬é‡Œçº¦50å¡è·¯é‡Œ
    
    // æ›´æ–°UI
    updateUI()
}
```

### 2. è½¨è¿¹ç¼©ç•¥å›¾ç”Ÿæˆ

```kotlin
class TrackThumbnailGenerator {
    companion object {
        fun generateThumbnail(
            context: Context,
            trackPoints: List<TrackPoint>,
            width: Int = 400,
            height: Int = 300
        ): String? {
            try {
                // 1. åˆ›å»ºåœ°å›¾è§†å›¾
                val mapView = TextureMapView(context)
                mapView.onCreate(null)
                
                val aMap = mapView.map
                aMap.apply {
                    mapType = AMap.MAP_TYPE_NORMAL
                    uiSettings.isZoomControlsEnabled = false
                    uiSettings.isCompassEnabled = false
                }
                
                // 2. æ·»åŠ è½¨è¿¹çº¿
                val polylineOptions = PolylineOptions()
                trackPoints.forEach { point ->
                    polylineOptions.add(LatLng(point.latitude, point.longitude))
                }
                polylineOptions.color(Color.BLUE)
                polylineOptions.width(10f)
                aMap.addPolyline(polylineOptions)
                
                // 3. è°ƒæ•´åœ°å›¾è§†é‡
                val bounds = calculateBounds(trackPoints)
                aMap.moveCamera(CameraUpdateFactory.newLatLngBounds(bounds, 50))
                
                // 4. ç­‰å¾…åœ°å›¾æ¸²æŸ“
                Thread.sleep(1000)
                
                // 5. æˆªå›¾ä¿å­˜
                aMap.getMapScreenShot(object : AMap.OnMapScreenShotListener {
                    override fun onMapScreenShot(bitmap: Bitmap?) {
                        bitmap?.let { saveThumbnail(it, context) }
                    }
                    
                    override fun onMapScreenShot(bitmap: Bitmap?, status: Int) {
                        onMapScreenShot(bitmap)
                    }
                })
                
                // 6. é‡Šæ”¾èµ„æº
                mapView.onDestroy()
                
            } catch (e: Exception) {
                e.printStackTrace()
                return null
            }
        }
        
        private fun saveThumbnail(bitmap: Bitmap, context: Context): String {
            val fileName = "track_thumb_${System.currentTimeMillis()}.jpg"
            val file = File(context.filesDir, "thumbnails/$fileName")
            file.parentFile?.mkdirs()
            
            FileOutputStream(file).use { out ->
                bitmap.compress(Bitmap.CompressFormat.JPEG, 80, out)
            }
            
            return file.absolutePath
        }
    }
}
```

### 3. ç‚¹èµä¸è¯„è®ºåŠŸèƒ½

#### ç‚¹èµé€»è¾‘

```kotlin
// MomentFragment.kt
private fun handleLike(post: CommunityPostEntity, position: Int) {
    val currentUserId = UserManager.getCurrentUserEmail(requireContext()) ?: return
    
    lifecycleScope.launch {
        try {
            val isLiked = withContext(Dispatchers.IO) {
                sportDatabase.likeDao().isLiked(post.id, currentUserId) > 0
            }
            
            withContext(Dispatchers.IO) {
                if (isLiked) {
                    // å–æ¶ˆç‚¹èµ
                    sportDatabase.likeDao().deleteLike(post.id, currentUserId)
                } else {
                    // æ·»åŠ ç‚¹èµ
                    val like = LikeEntity(
                        postId = post.id,
                        userId = currentUserId,
                        timestamp = System.currentTimeMillis()
                    )
                    sportDatabase.likeDao().insertLike(like)
                }
            }
            
            // é‡æ–°åŠ è½½ç‚¹èµæ•°æ®
            val newLikeCount = withContext(Dispatchers.IO) {
                sportDatabase.likeDao().getLikeCount(post.id)
            }
            
            val newIsLiked = !isLiked
            
            // æ›´æ–°UI
            adapter.updateLikeState(position, newIsLiked, newLikeCount)
            
        } catch (e: Exception) {
            Toast.makeText(requireContext(), "æ“ä½œå¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
        }
    }
}
```

#### è¯„è®ºåŠŸèƒ½

```kotlin
// PostDetailActivity.kt
private fun sendComment() {
    val content = binding.etComment.text.toString().trim()
    
    if (content.isEmpty()) {
        Toast.makeText(this, "è¯·è¾“å…¥è¯„è®ºå†…å®¹", Toast.LENGTH_SHORT).show()
        return
    }
    
    val currentUserId = UserManager.getCurrentUserEmail(this) ?: return
    val currentUserNickname = UserManager.getCurrentUserNickname(this) ?: "ç”¨æˆ·"
    val currentUserAvatar = UserManager.getCurrentUserAvatar(this) ?: "ic_twotone_person_24"
    
    val comment = CommentEntity(
        postId = postId,
        userId = currentUserId,
        userNickname = currentUserNickname,
        userAvatar = currentUserAvatar,
        content = content,
        timestamp = System.currentTimeMillis()
    )
    
    lifecycleScope.launch(Dispatchers.IO) {
        try {
            sportDatabase.commentDao().insertComment(comment)
            
            // è·å–æ›´æ–°åçš„è¯„è®ºåˆ—è¡¨
            val comments = sportDatabase.commentDao().getCommentsForPost(postId)
            
            withContext(Dispatchers.Main) {
                adapter.updateData(comments)
                binding.etComment.setText("")
                
                // æ»šåŠ¨åˆ°æœ€æ–°è¯„è®º
                binding.rvComments.smoothScrollToPosition(comments.size - 1)
                
                Toast.makeText(this@PostDetailActivity, "è¯„è®ºæˆåŠŸ", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            withContext(Dispatchers.Main) {
                Toast.makeText(this@PostDetailActivity, "è¯„è®ºå¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
            }
        }
    }
}
```

### 4. å›¾ç‰‡å¤„ç†ä¸Glideé›†æˆ

#### Glideé…ç½®

```kotlin
// åŠ è½½ç”¨æˆ·å¤´åƒ
Glide.with(context)
    .load(avatarPath)
    .placeholder(R.drawable.ic_twotone_person_24)  // å ä½å›¾
    .error(R.drawable.ic_twotone_person_24)        // é”™è¯¯å›¾
    .centerCrop()
    .into(imageView)

// åŠ è½½å¸–å­å›¾ç‰‡ï¼ˆä¼˜åŒ–å†…å­˜ï¼‰
Glide.with(context)
    .load(imagePath)
    .override(800, 800)  // é™åˆ¶å°ºå¯¸ï¼Œé˜²æ­¢OOM
    .centerCrop()
    .into(imageView)
```

#### å›¾ç‰‡ä¿å­˜ä¼˜åŒ–

```kotlin
// CreatePostActivity.kt
private fun saveImageToInternalStorage(uri: Uri): String? {
    var savedPath: String? = null
    
    lifecycleScope.launch(Dispatchers.IO) {
        try {
            val inputStream = contentResolver.openInputStream(uri)
            val imagesDir = File(filesDir, "post_images")
            if (!imagesDir.exists()) {
                imagesDir.mkdirs()
            }
            
            val imageFile = File(imagesDir, "post_${System.currentTimeMillis()}.jpg")
            val outputStream = FileOutputStream(imageFile)
            
            inputStream?.use { input ->
                outputStream.use { output ->
                    input.copyTo(output)
                }
            }
            
            savedPath = imageFile.absolutePath
            
            withContext(Dispatchers.Main) {
                Toast.makeText(this@CreatePostActivity, "å›¾ç‰‡ä¿å­˜æˆåŠŸ", Toast.LENGTH_SHORT).show()
            }
        } catch (e: Exception) {
            withContext(Dispatchers.Main) {
                Toast.makeText(this@CreatePostActivity, "å›¾ç‰‡ä¿å­˜å¤±è´¥: ${e.message}", Toast.LENGTH_SHORT).show()
            }
        }
    }
    
    return savedPath
}
```

---

## UI/UXè®¾è®¡è§„èŒƒ

### Material Design 3 ä¸»é¢˜

#### é¢œè‰²ç³»ç»Ÿ

```xml
<!-- res/values/colors.xml -->
<resources>
    <!-- Primary ä¸»è‰² -->
    <color name="md_theme_light_primary">#006C4C</color>
    <color name="md_theme_light_onPrimary">#FFFFFF</color>
    
    <!-- Secondary è¾…åŠ©è‰² -->
    <color name="md_theme_light_secondary">#4D6357</color>
    <color name="md_theme_light_onSecondary">#FFFFFF</color>
    
    <!-- Tertiary ç¬¬ä¸‰è‰² -->
    <color name="md_theme_light_tertiary">#3D6373</color>
    
    <!-- Error é”™è¯¯è‰² -->
    <color name="md_theme_light_error">#BA1A1A</color>
    
    <!-- Background èƒŒæ™¯è‰² -->
    <color name="md_theme_light_background">#FBFDF8</color>
    <color name="md_theme_light_onBackground">#191C1A</color>
    
    <!-- Surface è¡¨é¢è‰² -->
    <color name="md_theme_light_surface">#FBFDF8</color>
    <color name="md_theme_light_onSurface">#191C1A</color>
</resources>
```

#### å­—ä½“ç³»ç»Ÿ

```xml
<!-- res/values/themes.xml -->
<style name="TextAppearance.ICyclist.Headline">
    <item name="android:textSize">24sp</item>
    <item name="android:fontFamily">@font/roboto_medium</item>
</style>

<style name="TextAppearance.ICyclist.Body">
    <item name="android:textSize">16sp</item>
    <item name="android:fontFamily">@font/roboto_regular</item>
</style>

<style name="TextAppearance.ICyclist.Caption">
    <item name="android:textSize">12sp</item>
    <item name="android:fontFamily">@font/roboto_regular</item>
</style>
```

### å¸ƒå±€è§„èŒƒ

#### é—´è·ç³»ç»Ÿ

```kotlin
// ä½¿ç”¨8dpåŸºå‡†ç½‘æ ¼
spacing_xs = 4dp    // 0.5x
spacing_s = 8dp     // 1x
spacing_m = 16dp    // 2x
spacing_l = 24dp    // 3x
spacing_xl = 32dp   // 4x
spacing_xxl = 48dp  // 6x
```

#### å¡ç‰‡è®¾è®¡

```xml
<com.google.android.material.card.MaterialCardView
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:layout_margin="8dp"
    app:cardCornerRadius="12dp"
    app:cardElevation="2dp"
    app:strokeWidth="0dp">
    
    <!-- å¡ç‰‡å†…å®¹ -->
    
</com.google.android.material.card.MaterialCardView>
```

### äº¤äº’åé¦ˆ

#### æ¶Ÿæ¼ªæ•ˆæœ

```xml
<!-- æŒ‰é’®ç‚¹å‡»æ¶Ÿæ¼ª -->
android:background="?attr/selectableItemBackground"

<!-- åœ†å½¢æ¶Ÿæ¼ªï¼ˆç”¨äºå›¾æ ‡æŒ‰é’®ï¼‰ -->
android:background="?attr/selectableItemBackgroundBorderless"
```

#### çŠ¶æ€æç¤º

```kotlin
// Toastæç¤º
Toast.makeText(context, "æ“ä½œæˆåŠŸ", Toast.LENGTH_SHORT).show()

// Snackbaræç¤ºï¼ˆå¸¦æ“ä½œï¼‰
Snackbar.make(view, "åˆ é™¤æˆåŠŸ", Snackbar.LENGTH_LONG)
    .setAction("æ’¤é”€") {
        // æ’¤é”€æ“ä½œ
    }
    .show()

// Loadingå¯¹è¯æ¡†
val dialog = ProgressDialog(context).apply {
    setMessage("åŠ è½½ä¸­...")
    setCancelable(false)
}
dialog.show()
```

---

## æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å†…å­˜ä¼˜åŒ–

#### RecyclerViewä¼˜åŒ–

```kotlin
class SportRecordAdapter : RecyclerView.Adapter<SportRecordAdapter.ViewHolder>() {
    
    // ViewHolderå¤ç”¨
    class ViewHolder(val binding: ItemSportRecordBinding) : 
        RecyclerView.ViewHolder(binding.root)
    
    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ViewHolder {
        val binding = ItemSportRecordBinding.inflate(
            LayoutInflater.from(parent.context),
            parent,
            false
        )
        return ViewHolder(binding)
    }
    
    override fun onBindViewHolder(holder: ViewHolder, position: Int) {
        val record = records[position]
        
        // ä½¿ç”¨ViewBindingé¿å…findViewById
        holder.binding.apply {
            tvDistance.text = "%.2f km".format(record.distance / 1000f)
            tvDuration.text = formatDuration(record.duration)
            
            // ä½¿ç”¨GlideåŠ è½½ç¼©ç•¥å›¾
            record.thumbnailPath?.let { path ->
                Glide.with(root.context)
                    .load(File(path))
                    .override(200, 150)  // é™åˆ¶å°ºå¯¸
                    .into(ivThumbnail)
            }
        }
    }
    
    // å¯ç”¨å±€éƒ¨åˆ·æ–°
    override fun onBindViewHolder(holder: ViewHolder, position: Int, payloads: MutableList<Any>) {
        if (payloads.isEmpty()) {
            super.onBindViewHolder(holder, position, payloads)
        } else {
            // å¤„ç†å±€éƒ¨æ›´æ–°
        }
    }
}
```

#### å›¾ç‰‡å†…å­˜ä¼˜åŒ–

```kotlin
// Glideå…¨å±€é…ç½®
@GlideModule
class MyGlideModule : AppGlideModule() {
    override fun applyOptions(context: Context, builder: GlideBuilder) {
        // è®¾ç½®å†…å­˜ç¼“å­˜å¤§å°
        val memoryCacheSizeBytes = 1024 * 1024 * 20 // 20MB
        builder.setMemoryCache(LruResourceCache(memoryCacheSizeBytes.toLong()))
        
        // è®¾ç½®ç£ç›˜ç¼“å­˜å¤§å°
        val diskCacheSizeBytes = 1024 * 1024 * 100 // 100MB
        builder.setDiskCache(InternalCacheDiskCacheFactory(context, diskCacheSizeBytes.toLong()))
    }
}
```

### 2. å¯åŠ¨ä¼˜åŒ–

#### å»¶è¿Ÿåˆå§‹åŒ–

```kotlin
class MainContainerActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        
        // ç«‹å³åˆå§‹åŒ–ï¼šæ ¸å¿ƒUI
        setupUI()
        
        // å»¶è¿Ÿåˆå§‹åŒ–ï¼šéå…³é”®ç»„ä»¶
        lifecycleScope.launch {
            delay(500)
            initDatabase()
            initAnalytics()
        }
    }
}
```

### 3. æ•°æ®åº“ä¼˜åŒ–

#### æ‰¹é‡æ“ä½œ

```kotlin
// æ‰¹é‡æ’å…¥ï¼Œä½¿ç”¨äº‹åŠ¡
@Transaction
@Insert(onConflict = OnConflictStrategy.REPLACE)
suspend fun insertPosts(posts: List<CommunityPostEntity>)
```

#### åˆ†é¡µåŠ è½½

```kotlin
@Query("SELECT * FROM community_posts ORDER BY timestamp DESC LIMIT :limit OFFSET :offset")
suspend fun getPostsPaged(limit: Int, offset: Int): List<CommunityPostEntity>
```

---

## å®‰å…¨æœºåˆ¶

### 1. æ•°æ®åŠ å¯†

#### EncryptedSharedPreferences

```kotlin
object UserManager {
    private fun getEncryptedPreferences(context: Context): SharedPreferences {
        val masterKey = MasterKey.Builder(context)
            .setKeyScheme(MasterKey.KeyScheme.AES256_GCM)
            .build()
        
        return EncryptedSharedPreferences.create(
            context,
            "user_prefs",
            masterKey,
            EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV,
            EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM
        )
    }
}
```

### 2. æƒé™ç®¡ç†

```kotlin
// è¿è¡Œæ—¶æƒé™è¯·æ±‚
private fun requestLocationPermission() {
    if (ActivityCompat.checkSelfPermission(
            requireContext(),
            Manifest.permission.ACCESS_FINE_LOCATION
        ) != PackageManager.PERMISSION_GRANTED
    ) {
        requestPermissions(
            arrayOf(
                Manifest.permission.ACCESS_FINE_LOCATION,
                Manifest.permission.ACCESS_COARSE_LOCATION
            ),
            LOCATION_PERMISSION_REQUEST_CODE
        )
    } else {
        startLocationTracking()
    }
}
```

### 3. ç½‘ç»œå®‰å…¨

```xml
<!-- res/xml/network_security_config.xml -->
<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <domain-config cleartextTrafficPermitted="true">
        <domain includeSubdomains="true">10.0.2.2</domain>
    </domain-config>
</network-security-config>
```

---

## APIæ¥å£æ–‡æ¡£

### åŸºç¡€URL

```
http://localhost:8080/api/
```

### ç”¨æˆ·æ¥å£

#### æ³¨å†Œ
```http
POST /users/register
Content-Type: application/json

Request:
{
  "email": "user@example.com",
  "nickname": "éª‘è¡Œè€…",
  "password": "password123"
}

Response:
{
  "success": true,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "userId": 1,
    "email": "user@example.com",
    "nickname": "éª‘è¡Œè€…"
  }
}
```

#### ç™»å½•
```http
POST /users/login
Content-Type: application/json

Request:
{
  "email": "user@example.com",
  "password": "password123"
}

Response:
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "data": {
    "userId": 1,
    "email": "user@example.com",
    "nickname": "éª‘è¡Œè€…",
    "avatar": "http://..."
  }
}
```

### è¿åŠ¨è®°å½•æ¥å£

#### ä¿å­˜è¿åŠ¨è®°å½•
```http
POST /sport/records
Authorization: Bearer {token}
Content-Type: application/json

Request:
{
  "startTime": 1634567890000,
  "endTime": 1634571490000,
  "duration": 3600,
  "distance": 15000,
  "averageSpeed": 15.5,
  "maxSpeed": 25.8,
  "calories": 750,
  "trackPoints": [...]
}

Response:
{
  "success": true,
  "data": {
    "recordId": 123
  }
}
```

---

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```kotlin
@RunWith(AndroidJUnit4::class)
class SportDatabaseTest {
    private lateinit var database: SportDatabase
    private lateinit var sportRecordDao: SportRecordDao
    
    @Before
    fun setup() {
        val context = ApplicationProvider.getApplicationContext<Context>()
        database = Room.inMemoryDatabaseBuilder(context, SportDatabase::class.java)
            .build()
        sportRecordDao = database.sportRecordDao()
    }
    
    @Test
    fun insertAndGetSportRecord() = runBlocking {
        val record = SportRecordEntity(
            startTime = System.currentTimeMillis(),
            endTime = System.currentTimeMillis() + 3600000,
            duration = 3600,
            distance = 15000f,
            averageSpeed = 15.5f,
            maxSpeed = 25.8f,
            calories = 750,
            trackPoints = "[]"
        )
        
        sportRecordDao.insertRecord(record)
        val records = sportRecordDao.getAllRecords()
        
        assertEquals(1, records.size)
        assertEquals(15000f, records[0].distance)
    }
    
    @After
    fun tearDown() {
        database.close()
    }
}
```

### UIæµ‹è¯•

```kotlin
@RunWith(AndroidJUnit4::class)
@LargeTest
class LoginActivityTest {
    @get:Rule
    val activityRule = ActivityScenarioRule(LoginActivity::class.java)
    
    @Test
    fun testLogin() {
        // è¾“å…¥é‚®ç®±
        onView(withId(R.id.etEmail))
            .perform(typeText("test@example.com"), closeSoftKeyboard())
        
        // è¾“å…¥å¯†ç 
        onView(withId(R.id.etPassword))
            .perform(typeText("password123"), closeSoftKeyboard())
        
        // ç‚¹å‡»ç™»å½•æŒ‰é’®
        onView(withId(R.id.btnLogin))
            .perform(click())
        
        // éªŒè¯è·³è½¬åˆ°ä¸»é¡µ
        intended(hasComponent(MainContainerActivity::class.java.name))
    }
}
```

---

## é™„å½•

### å¸¸ç”¨å‘½ä»¤

```bash
# ç¼–è¯‘é¡¹ç›®
./gradlew build

# å®‰è£…Debugç‰ˆæœ¬
./gradlew installDebug

# æŸ¥çœ‹æ—¥å¿—
adb logcat | grep "iCyclist"

# æ¸…ç†é¡¹ç›®
./gradlew clean

# ç”ŸæˆAPK
./gradlew assembleRelease
```

### æ•…éšœæ’æŸ¥

1. **GPSå®šä½å¤±è´¥**
   - æ£€æŸ¥æƒé™æ˜¯å¦æˆäºˆ
   - ç¡®è®¤è®¾å¤‡GPSå·²å¼€å¯
   - åœ¨å®¤å¤–ç©ºæ—·ç¯å¢ƒæµ‹è¯•

2. **æ•°æ®åº“è¿ç§»å¤±è´¥**
   - å¸è½½åº”ç”¨é‡æ–°å®‰è£…
   - æ£€æŸ¥è¿ç§»ç­–ç•¥ä»£ç 

3. **å›¾ç‰‡åŠ è½½å¤±è´¥**
   - æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦å­˜åœ¨
   - éªŒè¯å­˜å‚¨æƒé™

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-17  
**ç»´æŠ¤è€…**: iCyclistå¼€å‘å›¢é˜Ÿ

