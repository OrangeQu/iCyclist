<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.icyclist.server.mapper.PostMapper">

    <resultMap id="PostResultMap" type="com.icyclist.server.model.Post">
        <id property="id" column="post_id"/>
        <result property="userId" column="post_user_id"/>
        <result property="rideRecordId" column="ride_record_id"/>
        <result property="content" column="post_content"/>
        <result property="createdAt" column="post_created_at"/>
        <result property="mediaUrls" column="media_urls" typeHandler="com.icyclist.server.handler.StringListTypeHandler"/>
        <association property="user" javaType="com.icyclist.server.model.User">
            <id property="id" column="user_id"/>
            <result property="username" column="username"/>
            <result property="nickname" column="nickname"/>
            <result property="avatar" column="avatar"/>
        </association>
    </resultMap>

    <sql id="postColumns">
        p.id as post_id,
        p.user_id as post_user_id,
        p.ride_record_id,
        p.content as post_content,
        p.media_urls,
        p.created_at as post_created_at,
        u.id as user_id,
        u.username,
        u.nickname,
        u.avatar
    </sql>

    <select id="findAll" resultMap="PostResultMap">
        SELECT <include refid="postColumns"/>
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        ORDER BY p.created_at DESC
    </select>

    <select id="findById" resultMap="PostResultMap">
        SELECT <include refid="postColumns"/>
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        WHERE p.id = #{id}
    </select>

    <select id="findByUserId" resultMap="PostResultMap">
        SELECT <include refid="postColumns"/>
        FROM post p
        LEFT JOIN user u ON p.user_id = u.id
        WHERE p.user_id = #{userId}
        ORDER BY p.created_at DESC
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO post (user_id, ride_record_id, content, media_urls)
        VALUES (
            #{userId},
            #{rideRecordId},
            #{content},
            #{mediaUrls, typeHandler=com.icyclist.server.handler.StringListTypeHandler}
        )
    </insert>

</mapper>


















